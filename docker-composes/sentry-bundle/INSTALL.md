TODO: Research a way to automate this full process - an ansible recipe or
      jenkins recipe would be great. To the automation, make into account the 
      automatic run of the psql commands below, and also that it will ask 
      for certificate info on setup.sh, and for 
      the admin user/password on sentry upgrade.

# INSTALLING

## Preparing

The script below will prepare our environment, creating the SSL certificate 
and also boostraping the required directories shared with the containers:

    $ ./setup.sh

## Copy the generated certificate to the local machine:
    $ cp -farv ./nginx/sentry.crt /tmp

## Setup the postgres database: 

### 1) Raise the container and enter it:

    $ docker-compose up -d postgres
    $ docker-compose run postgres sh -c 'exec psql -h "$POSTGRES_PORT_5432_TCP_ADDR" -p "$POSTGRES_PORT_5432_TCP_PORT" -U postgres'


### 2) Run the following SQL queries to setup the user and database:

    > CREATE ROLE sentry superuser;
    > ALTER ROLE sentry WITH LOGIN;
    > CREATE DATABASE sentry;

    ( then, quit pgsql and the container with <CTRL+D> )

## Build the remaining containers (including the sentry one). 

    This includes creating a sentry admin user/password, 
    which you will user to login into the sentry dashboard later:

    $ docker-compose build
    $ docker-compose run sentry sentry upgrade
      (sample credentials: admin user: tiagoprn@gmail.com; admin password: P2R0N1L6)

## Customize the sentry configuration:

	$ vim sentry/sentry.conf.py (to customize the host name and other configs)

The most important parameters are: 

    SENTRY_ADMIN_EMAIL – For notifications
    SENTRY_URL_PREFIX – This is the server IP or hostname - important for getting stats working
    SENTRY_ALLOW_ORIGIN – Where to allow communications from
    ALLOWED_HOSTS – Which hosts can communicate with Sentry

## Restart the containers, with the new configuration applied:

	$ ./restart.sh


# USING ON A FLASK APPLICATION: 

## Add the following libs to requirements.txt: 

	# sentry integration
	raven	
	blinker

(don't forget to ```pip install -r requirements.txt``` after finishing)

## On your flask app, configure sentry: 

    # ...

    import raven
    from raven.contrib.flask import Sentry

    # ...

    def create_app():
        app = Flask(__name__)
        app.config.from_object(settings)

        # Since the container used as the backend to Sentry
        # automatically enables and generates a SSL certificate,
        # we must specify the path for the generated certificate
        # file. So, the machine which runs this flask app must have
        # a local copy of the certificate ".crt" file generated by the server.
        # Finally, to enable the connection to the sentry server,
        # we must append the certificate full path on the
        # SENTRY_DSN, as the parameter "ca_certs" to raven.Client below.
        SENTRY_SERVER_CERTIFICATE_FILE_PATH = '/tmp/sentry.crt'
        SENTRY_DSN = ('https://4f69a931918a4fd980ad9a59f5c23f38'
                    ':53ba678b72404b7080f785e2a7719e0c'
                    '@172.17.0.1/1?ca_certs={}'.format(
                        SENTRY_SERVER_CERTIFICATE_FILE_PATH))

        client = raven.Client(dsn=SENTRY_DSN)
        sentry = Sentry(client=client)
        sentry.init_app(app)

        # ...

        return app

